<ion-content class="fondo" [fullscreen]="true">
  <div class="page-inner">
    <app-header-usuario></app-header-usuario>

    <!-- Filtros -->
    <div class="filtros filters-card">
      <ion-segment [(ngModel)]="filtroTipo" class="chip-segment" (ionChange)="onFiltroChange()">
        <ion-segment-button value="todos">
          Todos
          <span *ngIf="estadisticasFiltros.total > 0" class="filter-count">
            {{ estadisticasFiltros.total }}
          </span>
        </ion-segment-button>
        <ion-segment-button value="beneficios">
          Beneficios
          <span *ngIf="estadisticasFiltros.beneficios > 0" class="filter-count">
            {{ estadisticasFiltros.beneficios }}
          </span>
        </ion-segment-button>
        <ion-segment-button value="productos">
          Productos
          <span *ngIf="estadisticasFiltros.productos > 0" class="filter-count">
            {{ estadisticasFiltros.productos }}
          </span>
        </ion-segment-button>
      </ion-segment>

      <ion-segment [(ngModel)]="ordenFecha" class="chip-segment" (ionChange)="onOrdenChange()">
        <ion-segment-button value="desc">Más recientes</ion-segment-button>
        <ion-segment-button value="asc">Más antiguos</ion-segment-button>
      </ion-segment>
      
      <!-- ✅ Indicador de estado -->
      <div class="filter-status" *ngIf="historialFiltrado.length > 0">
        <ion-icon name="funnel-outline"></ion-icon>
        <span>{{ mensajeEstadoFiltros }}</span>
      </div>
    </div>

    <!-- Feed de notificaciones -->
    <div class="feed-container">
      <div class="feed" *ngIf="historialFiltrado?.length; else emptyTpl">
        <article class="feed-item" *ngFor="let item of historialFiltrado">
          <div class="fi-left">
            <div class="fi-icon" [ngClass]="iconClass(item)">
              <ion-icon [name]="iconName(item)"></ion-icon>
            </div>
          </div>

          <div class="fi-main">
            <!-- ✅ Beneficio seguro -->
            <ng-container *ngIf="item.beneficio as ben; else sinBeneficio">
              <div class="fi-title">{{ ben.nombre }}</div>
            </ng-container>
            <ng-template #sinBeneficio>
              <div class="fi-title">—</div>
            </ng-template>

            <div class="fi-meta">
              <!-- ✅ Estado seguro -->
              <ng-container *ngIf="item.estado as est; else sinEstado">
                <span class="estado" [ngClass]="est.toLowerCase()">{{ est }}</span>
              </ng-container>
              <ng-template #sinEstado>
                <span class="estado">—</span>
              </ng-template>

              <span class="fi-dot">•</span>
              <time class="fi-date">{{ item.fechaCanje | date:'short' }}</time>
            </div>
          </div>

          <div class="fi-actions">
            <button class="btn-detalle" (click)="verDetalle(item)">
              <ion-icon name="information-circle-outline"></ion-icon>
              Detalle
            </button>
          </div>
        </article>
      </div>

      <ng-template #emptyTpl>
        <div class="empty">Aún no tienes movimientos</div>
      </ng-template>
    </div>

    <!-- Footer anclado al fondo -->
    <app-footer class="footer-pinned"></app-footer>
  </div>
</ion-content>
