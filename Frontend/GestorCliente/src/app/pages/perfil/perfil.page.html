<ion-content class="fondo" [fullscreen]="true">
  <app-header-usuario></app-header-usuario>

  <div class="user-dashboard" [class.editing]="isEditing" *ngIf="cargado; else loadingTpl">
    <!-- ===== ENCABEZADO PERFIL ===== -->
    <section class="perfil-header">
      <div class="avatar-box">
        <img [src]="avatarPreview || perfil?.fotoUrl || defaultAvatar" (error)="onImgError($event)"
          alt="Foto de perfil" />
        <input #fileInput type="file" accept="image/*" hidden (change)="onFotoSeleccionada($event)" />
      </div>

      <div class="perfil-resumen">
        <h1>{{ perfil?.nombreCompleto || '-' }} {{ perfil?.apellidoCompleto || '' }}</h1>

        <div class="mini">
          <ion-chip color="warning" class="chip-nivel" *ngIf="perfil?.categoriaNombre">
            <ion-icon name="medal-outline"></ion-icon>
            <ion-label>{{ perfil?.categoriaNombre }}</ion-label>
          </ion-chip>

          <ion-chip class="chip-puntos">
            <ion-icon name="diamond-outline"></ion-icon>
            <ion-label>{{ (perfil?.puntosTotal || 0) | number }} pts</ion-label>
          </ion-chip>
        </div>

        <p class="email" *ngIf="perfil?.email">
          <ion-icon name="mail-outline"></ion-icon> {{ perfil?.email }}
        </p>
        <p class="small">Última actualización: {{ perfil?.fechaUltimaActualizacion || '-' }}</p>
      </div>
    </section>

    <!-- ===== DETALLE (LECTURA/EDICIÓN) ===== -->
    <ion-card class="perfil-card" [formGroup]="form">
      <ion-card-header>
        <div class="perfil-header">
          <div class="perfil-title">
            <ion-card-title>Datos del usuario</ion-card-title>
            <ion-card-subtitle>
              Casino:
              <b>{{ ($any(perfil)?.sistema_nombre) || perfil?.sistemaNombre || ('#' + perfil?.sistemaId) }}</b>
            </ion-card-subtitle>
          </div>
          <div class="perfil-actions">
            <ion-button 
              fill="outline" 
              size="small" 
              color="warning"
              (click)="irAMisSolicitudes()">
              <ion-icon name="document-text-outline" slot="start"></ion-icon>
              Mis Solicitudes
            </ion-button>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>
        <ion-grid class="perfil-grid">
          <!-- PERSONALES -->
          <ion-row class="bloque-titulo"><ion-col>Datos personales</ion-col></ion-row>
          <ion-row>
            <!-- Nombres -->
            <ion-col size-md="6">
              <ion-item class="static-item">
                <ion-label position="stacked">Nombres</ion-label>
                <div class="static-value">{{ perfil?.nombreCompleto || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('nombreCompleto')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>

            <!-- Apellidos -->
            <ion-col size-md="6">
              <ion-item class="static-item">
                <ion-label position="stacked">Apellidos</ion-label>
                <div class="static-value">{{ perfil?.apellidoCompleto || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('apellidoCompleto')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>

            <!-- Fecha Nacimiento -->
            <ion-col size-md="6">
              <ion-item class="static-item" *ngIf="!isEditing; else edFecha">
                <ion-label position="stacked">Fecha de nacimiento</ion-label>
                <div class="static-value">{{ perfil?.fechaCumpleanos || '—' }}</div>
              </ion-item>
              <ng-template #edFecha>
                <ion-item>
                  <ion-label position="stacked">Fecha de nacimiento</ion-label>
                  <div class="fecha-select-group">
                    <select class="fecha-select" formControlName="fechaDia">
                      <option value="" disabled>Día</option>
                      <option *ngFor="let d of diasDisponibles" [value]="d">{{ d }}</option>
                    </select>
                    <select class="fecha-select" formControlName="fechaMes">
                      <option value="" disabled>Mes</option>
                      <option *ngFor="let m of mesesDisponibles; let i = index" [value]="i + 1">{{ m }}</option>
                    </select>
                    <select class="fecha-select" formControlName="fechaAnio">
                      <option value="" disabled>Año</option>
                      <option *ngFor="let a of aniosDisponibles" [value]="a">{{ a }}</option>
                    </select>
                  </div>
                  <small *ngIf="fechaSeleccionadaCompleta && !fechaNacimientoValida" style="color:#f3d98b">
                    Debes tener al menos 18 años y máximo 100 años
                  </small>
                </ion-item>
              </ng-template>
            </ion-col>

            <!-- Usuario (no editable) -->
            <ion-col size-md="6">
              <ion-item class="static-item no-edit">
                <ion-label position="stacked">Usuario</ion-label>
                <div class="static-value">{{ perfil?.login || '—' }}</div>
              </ion-item>
            </ion-col>
          </ion-row>

          <!-- CONTACTO -->
          <ion-row class="bloque-titulo"><ion-col>Contacto</ion-col></ion-row>
          <ion-row>
            <!-- Email (NO editable) -->
            <ion-col size-md="6">
              <ion-item class="static-item no-edit">
                <ion-label position="stacked">Email</ion-label>
                <div class="static-value">{{ perfil?.email || '—' }}</div>
              </ion-item>
            </ion-col>

            <!-- Celular -->
            <ion-col size-md="6">
              <ion-item class="static-item">
                <ion-label position="stacked">Celular</ion-label>
                <div class="static-value">{{ perfil?.celular || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('celular')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>
          </ion-row>

          <!-- DOCUMENTO -->
          <ion-row class="bloque-titulo"><ion-col>Documento</ion-col></ion-row>
          <ion-row>
            <ion-col size-md="6">
              <ion-item class="static-item">
                <ion-label position="stacked">Tipo de documento</ion-label>
                <div class="static-value">{{ perfil?.tipoDocumento || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('tipoDocumento')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>
            <ion-col size-md="6">
              <ion-item class="static-item">
                <ion-label position="stacked">Número de documento</ion-label>
                <div class="static-value">{{ perfil?.numeroDocumento || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('numeroDocumento')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>
          </ion-row>

          <!-- DIRECCIÓN -->
          <ion-row class="bloque-titulo"><ion-col>Dirección</ion-col></ion-row>
          <ion-row>

            <!-- PAÍS -->
            <ion-col size-md="6">
              <ion-item class="static-item">
                <ion-label position="stacked">País</ion-label>
                <div class="static-value">{{ perfil?.pais || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('pais')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>

            <!-- REGIÓN -->
            <ion-col size-md="6">
              <ion-item class="static-item">
                <ion-label position="stacked">Región</ion-label>
                <div class="static-value">{{ perfil?.region || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('region')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>

            <!-- COMUNA -->
            <ion-col size-md="6">
              <ion-item class="static-item">
                <ion-label position="stacked">Comuna</ion-label>
                <div class="static-value">{{ perfil?.comuna || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('comuna')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>


            <!-- CALLE -->
            <ion-col size-md="6">
              <ion-item class="static-item">
                <ion-label position="stacked">Calle</ion-label>
                <div class="static-value">{{ perfil?.calle || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('calle')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>

            <!-- NÚMERO -->
            <ion-col size-md="6">
              <ion-item class="static-item">
                <ion-label position="stacked">Número</ion-label>
                <div class="static-value">{{ perfil?.numero || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('numero')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>

            <!-- NOTA ENTREGA -->
            <ion-col size="12">
              <ion-item class="static-item textarea-item">
                <ion-label position="stacked">Nota de entrega</ion-label>
                <div class="static-value multiline">{{ perfil?.notaEntrega || '—' }}</div>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small" 
                  color="warning"
                  (click)="solicitarCambio('notaEntrega')">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-col>

          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- ACCIONES -->
    <div class="acciones-secundarias">
      <ion-button fill="outline" color="warning" routerLink="/cambio-pass">
        <ion-icon name="key-outline" slot="start"></ion-icon>
        Cambiar contraseña
      </ion-button>
    </div>
  </div>

  <ng-template #loadingTpl>
    <ion-spinner name="crescent" style="margin: 32px auto; display: block;"></ion-spinner>
  </ng-template>

  <app-footer></app-footer>
</ion-content>