<ion-content class="fondo" [fullscreen]="true">
  <app-header-usuario></app-header-usuario>

  <div class="user-dashboard" [class.editing]="isEditing" *ngIf="cargado; else loadingTpl">
    <!-- ===== ENCABEZADO PERFIL ===== -->
    <section class="perfil-header">
      <div class="avatar-box">
        <img [src]="avatarPreview || perfil?.fotoUrl || defaultAvatar" (error)="onImgError($event)"
          alt="Foto de perfil" />
        <input #fileInput type="file" accept="image/*" hidden (change)="onFotoSeleccionada($event)" />
      </div>

      <div class="perfil-resumen">
        <h1>{{ perfil?.nombreCompleto || '-' }} {{ perfil?.apellidoCompleto || '' }}</h1>

        <div class="mini">
          <ion-chip color="warning" class="chip-nivel" *ngIf="perfil?.categoriaNombre">
            <ion-icon name="medal-outline"></ion-icon>
            <ion-label>{{ perfil?.categoriaNombre }}</ion-label>
          </ion-chip>

          <ion-chip class="chip-puntos">
            <ion-icon name="diamond-outline"></ion-icon>
            <ion-label>{{ (perfil?.puntosTotal || 0) | number }} pts</ion-label>
          </ion-chip>
        </div>

        <p class="email" *ngIf="perfil?.email">
          <ion-icon name="mail-outline"></ion-icon> {{ perfil?.email }}
        </p>
        <p class="small">Última actualización: {{ perfil?.fechaUltimaActualizacion || '-' }}</p>
      </div>
    </section>

    <!-- ===== DETALLE (LECTURA/EDICIÓN) ===== -->
    <ion-card class="perfil-card" [formGroup]="form">
      <ion-card-header>
        <ion-card-title>Datos del usuario</ion-card-title>
        <ion-card-subtitle>
          Casino:
          <b>{{ ($any(perfil)?.sistema_nombre) || perfil?.sistemaNombre || ('#' + perfil?.sistemaId) }}</b>
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <ion-grid class="perfil-grid">
          <!-- PERSONALES -->
          <ion-row class="bloque-titulo"><ion-col>Datos personales</ion-col></ion-row>
          <ion-row>
            <!-- Nombres -->
            <ion-col size-md="6">
              <ion-item class="static-item" *ngIf="!isEditing; else edNombre">
                <ion-label position="stacked">Nombres</ion-label>
                <div class="static-value">{{ perfil?.nombreCompleto || '—' }}</div>
              </ion-item>
              <ng-template #edNombre>
                <ion-item>
                  <ion-label position="floating">Nombres</ion-label>
                  <ion-input formControlName="nombreCompleto"></ion-input>
                </ion-item>
              </ng-template>
            </ion-col>

            <!-- Apellidos -->
            <ion-col size-md="6">
              <ion-item class="static-item" *ngIf="!isEditing; else edApellido">
                <ion-label position="stacked">Apellidos</ion-label>
                <div class="static-value">{{ perfil?.apellidoCompleto || '—' }}</div>
              </ion-item>
              <ng-template #edApellido>
                <ion-item>
                  <ion-label position="floating">Apellidos</ion-label>
                  <ion-input formControlName="apellidoCompleto"></ion-input>
                </ion-item>
              </ng-template>
            </ion-col>

            <!-- Fecha Nacimiento -->
            <ion-col size-md="6">
              <ion-item class="static-item" *ngIf="!isEditing; else edFecha">
                <ion-label position="stacked">Fecha de nacimiento</ion-label>
                <div class="static-value">{{ perfil?.fechaCumpleanos || '—' }}</div>
              </ion-item>
              <ng-template #edFecha>
                <ion-item>
                  <ion-label position="stacked">Fecha de nacimiento</ion-label>
                  <div class="fecha-select-group">
                    <select class="fecha-select" formControlName="fechaDia">
                      <option value="" disabled>Día</option>
                      <option *ngFor="let d of diasDisponibles" [value]="d">{{ d }}</option>
                    </select>
                    <select class="fecha-select" formControlName="fechaMes">
                      <option value="" disabled>Mes</option>
                      <option *ngFor="let m of mesesDisponibles; let i = index" [value]="i + 1">{{ m }}</option>
                    </select>
                    <select class="fecha-select" formControlName="fechaAnio">
                      <option value="" disabled>Año</option>
                      <option *ngFor="let a of aniosDisponibles" [value]="a">{{ a }}</option>
                    </select>
                  </div>
                  <small *ngIf="fechaSeleccionadaCompleta && !fechaNacimientoValida" style="color:#f3d98b">
                    Debes tener al menos 18 años y máximo 100 años
                  </small>
                </ion-item>
              </ng-template>
            </ion-col>

            <!-- Usuario (no editable) -->
            <ion-col size-md="6">
              <ion-item class="static-item no-edit">
                <ion-label position="stacked">Usuario</ion-label>
                <div class="static-value">{{ perfil?.login || '—' }}</div>
              </ion-item>
            </ion-col>
          </ion-row>

          <!-- CONTACTO -->
          <ion-row class="bloque-titulo"><ion-col>Contacto</ion-col></ion-row>
          <ion-row>
            <!-- Email (NO editable) -->
            <ion-col size-md="6">
              <ion-item class="static-item no-edit">
                <ion-label position="stacked">Email</ion-label>
                <div class="static-value">{{ perfil?.email || '—' }}</div>
              </ion-item>
            </ion-col>

            <!-- Celular -->
            <ion-col size-md="6">
              <ion-item class="static-item" *ngIf="!isEditing; else edCel">
                <ion-label position="stacked">Celular</ion-label>
                <div class="static-value">{{ perfil?.celular || '—' }}</div>
              </ion-item>
              <ng-template #edCel>
                <ion-item>
                  <ion-label position="floating">Celular</ion-label>
                  <ion-input formControlName="celular"></ion-input>
                </ion-item>
              </ng-template>
            </ion-col>
          </ion-row>

          <!-- DOCUMENTO -->
          <ion-row class="bloque-titulo"><ion-col>Documento</ion-col></ion-row>
          <ion-row>
            <ion-col size-md="6">
              <ion-item class="static-item no-edit">
                <ion-label position="stacked">Tipo de documento</ion-label>
                <div class="static-value">{{ perfil?.tipoDocumento || '—' }}</div>
              </ion-item>
            </ion-col>
            <ion-col size-md="6">
              <ion-item class="static-item no-edit">
                <ion-label position="stacked">Número de documento</ion-label>
                <div class="static-value">{{ perfil?.numeroDocumento || '—' }}</div>
              </ion-item>
            </ion-col>
          </ion-row>

          <!-- DIRECCIÓN -->
          <ion-row class="bloque-titulo"><ion-col>Dirección</ion-col></ion-row>
          <ion-row>

            <!-- PAÍS -->
            <ion-col size-md="6">
              <ion-item [class.static-item]="!isEditing">
                <ion-label position="stacked">País</ion-label>
                <ng-container *ngIf="!isEditing; else paisEdit">
                  <div class="static-value">{{ perfil?.pais || '—' }}</div>
                </ng-container>
                <ng-template #paisEdit>
                  <ion-select formControlName="pais" interface="popover">
                    <ion-select-option value="Chile">Chile</ion-select-option>
                    <ion-select-option value="Perú" disabled>Perú (pronto)</ion-select-option>
                  </ion-select>
                </ng-template>
              </ion-item>
            </ion-col>

            <!-- REGIÓN -->
            <ion-col size-md="6">
              <ion-item [class.static-item]="!isEditing">
                <ion-label position="stacked">Región</ion-label>
                <ng-container *ngIf="!isEditing; else regEdit">
                  <div class="static-value">{{ perfil?.region || '—' }}</div>
                </ng-container>
                <ng-template #regEdit>
                  <ion-select formControlName="regionCodigo" interface="popover"
                    [disabled]="form.value.pais !== 'Chile'" [compareWith]="compareById">
                    <ion-select-option *ngFor="let r of (regiones$ | async); trackBy: trByCodigo"
                      [value]="toStr(r.codigo)">
                      {{ r.nombre }}
                    </ion-select-option>
                  </ion-select>
                </ng-template>
              </ion-item>
            </ion-col>

            <!-- COMUNA -->
            <ion-col size-md="6">
              <ion-item [class.static-item]="!isEditing">
                <ion-label position="stacked">Comuna</ion-label>
                <ng-container *ngIf="!isEditing; else comEdit">
                  <div class="static-value">{{ perfil?.comuna || '—' }}</div>
                </ng-container>
                <ng-template #comEdit>
                  <ion-select formControlName="comunaCodigo" interface="popover" [disabled]="!form.value.regionCodigo"
                    [compareWith]="compareById">
                    <ion-select-option *ngFor="let c of (comunas$ | async); trackBy: trByCodigo"
                      [value]="toStr(c.codigo)">
                      {{ c.nombre }}
                    </ion-select-option>
                  </ion-select>
                </ng-template>
              </ion-item>
            </ion-col>


            <!-- CALLE -->
            <ion-col size-md="6">
              <ion-item class="static-item" *ngIf="!isEditing; else edCalle">
                <ion-label position="stacked">Calle</ion-label>
                <div class="static-value">{{ perfil?.calle || '—' }}</div>
              </ion-item>
              <ng-template #edCalle>
                <ion-item>
                  <ion-label position="floating">Calle</ion-label>
                  <ion-input formControlName="calle"></ion-input>
                </ion-item>
              </ng-template>
            </ion-col>

            <!-- NÚMERO -->
            <ion-col size-md="6">
              <ion-item class="static-item" *ngIf="!isEditing; else edNumero">
                <ion-label position="stacked">Número</ion-label>
                <div class="static-value">{{ perfil?.numero || '—' }}</div>
              </ion-item>
              <ng-template #edNumero>
                <ion-item>
                  <ion-label position="floating">Número</ion-label>
                  <ion-input formControlName="numero"></ion-input>
                </ion-item>
              </ng-template>
            </ion-col>

            <!-- NOTA ENTREGA -->
            <ion-col size="12">
              <ion-item class="static-item textarea-item" *ngIf="!isEditing; else edNota">
                <ion-label position="stacked">Nota de entrega</ion-label>
                <div class="static-value multiline">{{ perfil?.notaEntrega || '—' }}</div>
              </ion-item>
              <ng-template #edNota>
                <ion-item class="textarea-item">
                  <ion-label position="stacked">Nota de entrega</ion-label>
                  <ion-textarea autoGrow="true" formControlName="notaEntrega" rows="3" maxlength="300"></ion-textarea>
                </ion-item>
              </ng-template>
            </ion-col>

          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- ACCIONES -->
    <div class="acciones-secundarias">
      <ng-container *ngIf="!isEditing; else editBtns">
        <ion-button fill="outline" color="warning" (click)="toggleEditar()">
          <ion-icon name="create-outline" slot="start"></ion-icon>
          Editar perfil
        </ion-button>
      </ng-container>

      <ng-template #editBtns>
        <ion-button fill="outline" color="success" (click)="guardar()">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Guardar cambios
        </ion-button>
        <ion-button fill="outline" color="medium" (click)="cancelar()">
          <ion-icon name="close-outline" slot="start"></ion-icon>
          Cancelar
        </ion-button>
      </ng-template>

      <ion-button fill="outline" color="warning" routerLink="/cambio-pass">
        <ion-icon name="key-outline" slot="start"></ion-icon>
        Cambiar contraseña
      </ion-button>
    </div>
  </div>

  <ng-template #loadingTpl>
    <ion-spinner name="crescent" style="margin: 32px auto; display: block;"></ion-spinner>
  </ng-template>

  <app-footer></app-footer>
</ion-content>